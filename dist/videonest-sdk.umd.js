!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("debug"),require("react")):"function"==typeof define&&define.amd?define(["exports","debug","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VideonestSDK={},e.debugModule,e.React)}(this,(function(e,t,s){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var i=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,i.get?i:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var a=i(t),n=o(s);let r=!1;const d=a.default("videonest-sdk");const l=function(e,...t){r&&d(e,...t)};function c(e,...t){r&&(console.log(`[videonest-sdk] ${e}`,...t),d(e,...t))}class u{constructor(){this.samples=[],this.avgSpeed=null,this.globalThroughput=0}recordChunkUpload(e,t){const s=8*e/(t/1e3)/1e6;return this.samples.push(s),this.samples.length>5&&this.samples.shift(),this.avgSpeed=this.calculateWeightedAverage(this.samples),this.globalThroughput=this.samples.reduce(((e,t)=>e+t),0),this.avgSpeed}calculateWeightedAverage(e){if(0===e.length)return 0;let t=0,s=0;return e.forEach(((e,i)=>{const o=i+1;t+=e*o,s+=o})),t/s}}class h{constructor(e,t,s){this.uploadQueue=[],this.activeUploads=new Map,this.completedChunks=new Set,this.failedChunks=new Set,this.speedDetector=new u,this.uploadId="",this.chunkBytesUploaded=new Map,this.totalBytesUploaded=0,this.startTime=0,this.lastProgressReport=0,this.stalledChunks=new Set,this.file=e,this.metadata=t,this.config=s,this.chunkSize=function(e){let t;return t=e<52428800?8388608:e<524288e3?26214400:e<2147483648?52428800:104857600,Math.floor(t)}(e.size),this.totalChunks=Math.ceil(e.size/this.chunkSize),console.log(`🚀 SDK Upload manager initialized: ${this.totalChunks} chunks, ${h.CONCURRENCY} concurrency, ${(this.chunkSize/1024/1024).toFixed(1)}MB chunk size`)}async upload(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));this.uploadId=t,this.startTime=Date.now();for(let e=0;e<this.totalChunks;e++)this.chunkBytesUploaded.set(e,0);for(let e=0;e<this.totalChunks;e++)this.uploadQueue.push({index:e,uploadId:t,retries:0,maxRetries:3,priority:this.calculateChunkPriority(e)});this.uploadQueue.sort(((e,t)=>t.priority-e.priority));const s=[];for(let t=0;t<h.CONCURRENCY;t++)s.push(this.uploadWorker(e));if(this.stallMonitor=setInterval((()=>this.checkForStalledUploads()),1e4),await Promise.all(s),this.stallMonitor&&clearInterval(this.stallMonitor),this.failedChunks.size>0)throw new Error(`Failed to upload ${this.failedChunks.size} chunks after retries`);return console.log(`✅ SDK Upload completed in ${((Date.now()-this.startTime)/1e3).toFixed(1)}s`),{uploadId:t,totalChunks:this.totalChunks}}calculateChunkPriority(e){return 0===e?100:e===this.totalChunks-1?90:50}async uploadWorker(e){for(;this.uploadQueue.length>0||this.activeUploads.size>0;)if(this.uploadQueue.length>0&&this.activeUploads.size<h.CONCURRENCY){const t=this.uploadQueue.shift();if(t)try{await this.uploadChunk(t,e)}catch(e){this.handleChunkError(t,e)}}else await new Promise((e=>setTimeout(e,100)))}async uploadChunk(e,t){const{index:s,uploadId:i}=e,o=s*this.chunkSize,a=Math.min(o+this.chunkSize,this.file.size),n=this.file.slice(o,a),r=n.size;if(0===r)throw new Error(`Empty chunk detected for index ${s}`);this.activeUploads.set(s,{...e,startTime:Date.now()});const d=new FormData;if(d.append("chunk",n),d.append("uploadId",i),d.append("chunkIndex",s.toString()),d.append("totalChunks",this.totalChunks.toString()),d.append("fileName",this.file.name),d.append("fileSize",this.file.size.toString()),d.append("totalConcurrentVideos","1"),0===s&&(d.append("channelId",this.metadata.channelId.toString()),this.metadata.title&&d.append("title",this.metadata.title),this.metadata.description&&d.append("description",this.metadata.description),this.metadata.tags)){const e=Array.isArray(this.metadata.tags)?this.metadata.tags.join(","):this.metadata.tags;e&&e.length>0&&d.append("tags",e)}const l=Date.now(),c=this.config.baseUrl||"https://api1.videonest.co";return new Promise(((e,i)=>{const o=new XMLHttpRequest;o.timeout=12e4,o.upload.onprogress=e=>{if(e.lengthComputable){this.chunkBytesUploaded.set(s,e.loaded),this.totalBytesUploaded=Array.from(this.chunkBytesUploaded.values()).reduce(((e,t)=>e+t),0);const i=Date.now();if(i-this.lastProgressReport>100){const e=this.totalBytesUploaded/this.file.size*100;t(e),this.lastProgressReport=i}}},o.open("POST",`${c}/sdk/${this.config.channelId}/upload-chunk-v2`),o.setRequestHeader("Authorization",`Bearer ${this.config.apiKey}`),o.onload=()=>{if(o.status>=200&&o.status<300)try{const t=JSON.parse(o.responseText);if(t.success){const i=Date.now()-l;this.speedDetector.recordChunkUpload(r,i);this.activeUploads.delete(s),this.completedChunks.add(s),this.chunkBytesUploaded.set(s,r),e(t)}else i(new Error(t.message||"Chunk upload failed"))}catch(e){i(new Error("Invalid response from server"))}else i(new Error(`HTTP error: ${o.status}`))},o.onerror=()=>i(new Error("Network error during upload")),o.ontimeout=()=>i(new Error("Upload timeout - chunk may be too large")),o.send(d)}))}handleChunkError(e,t){console.error(`Chunk ${e.index} upload failed:`,t.message),e.retries<e.maxRetries?(e.retries++,setTimeout((()=>{this.uploadQueue.unshift(e)}),1e3*Math.pow(2,e.retries))):(this.failedChunks.add(e.index),this.activeUploads.delete(e.index))}checkForStalledUploads(){const e=Date.now();for(const[t,s]of this.activeUploads.entries())e-s.startTime>3e4&&(console.warn(`⚠️ SDK: Chunk ${t} appears stalled, will retry`),this.stalledChunks.add(t),this.activeUploads.delete(t),this.uploadQueue.unshift({...s,retries:s.retries+1}))}getUploadStats(){return{totalChunks:this.totalChunks,completedChunks:this.completedChunks.size,failedChunks:this.failedChunks.size,activeUploads:this.activeUploads.size,concurrency:h.CONCURRENCY,avgSpeed:this.speedDetector.avgSpeed,progress:this.totalBytesUploaded/this.file.size*100}}}h.CONCURRENCY=6;class p{constructor(e){this.config=e,l("VideonestClient initialized with channelId:",e.channelId)}async uploadVideo(e,t){c("Starting optimized video upload process"),c(`File: ${e.name}, size: ${e.size} bytes`);try{const{metadata:s,onProgress:i=()=>{},thumbnail:o}=t;if(!o)throw c("Error: Thumbnail is required"),new Error("Thumbnail is required for video upload");c("Upload options:",{metadata:s,hasThumbnail:!!o});const a={...s,channelId:this.config.channelId};c("Upload metadata:",a);const n=new h(e,a,this.config),{uploadId:r,totalChunks:d}=await n.upload(i);c(`All chunks uploaded. Finalizing upload... (uploadId: ${r}, totalChunks: ${d})`);const l={fileName:e.name,uploadId:r,totalChunks:d.toString(),title:a.title||"Untitled Video",description:a.description||"",tags:a.tags?Array.isArray(a.tags)?a.tags.join(","):a.tags:""};c("Finalize request data:",l);const u=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/finalize-v2`,{method:"POST",body:JSON.stringify(l),headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`}});c(`Finalize response status: ${u.status}`);const p=await u.json();if(c("Finalize response data:",p),!p.success)throw c(`Finalization failed: ${p.message}`),new Error(p.message||"Upload finalization failed");return c("Upload successfully finalized"),c("Uploading user-provided thumbnail"),await this.uploadThumbnail(o,p.video.id),c("Upload process completed successfully"),p}catch(e){return c(`Upload error: ${e instanceof Error?e.message:"Unknown error"}`,e),{success:!1,message:e instanceof Error?e.message:"An unexpected error occurred during upload"}}}async trackVideoUpload(e,t){l("Tracking video upload:",e,t);try{let s,i="",o="POST";const a="https://api1.videonest.co";if("start"===e)i="/video-stats/upload-sessions",o="POST",s={session_id:t.sessionId,user_id:t.userId,video_id:t.videoId||0,filename:t.filename,file_size:t.fileSize,chunks_count:t.chunksCount||0,status:"in_progress"};else if(("complete"===e||"failed"===e)&&(i=`/video-stats/upload-sessions/${t.sessionId}`,o="POST",s={video_id:t.videoId,end_time:(new Date).toISOString(),status:t.status},t.startTime)){const e=Date.now()-t.startTime;if(s.total_duration=`${Math.floor(e/1e3)} seconds`,t.fileSize&&e>0){const i=8*t.fileSize/(e/1e3);s.avg_speed_mbps=parseFloat((i/1e6).toFixed(2))}}const n=`${a}${i}`;l("Upload session request:",{action:e,url:n,method:o,body:s});const r={"Content-Type":"application/json"};this.config.apiKey&&(r["X-API-Key"]=this.config.apiKey),this.config.channelId&&(r["X-Channel-ID"]=this.config.channelId.toString());const d=await fetch(n,{method:o,headers:r,body:JSON.stringify(s)});if(!d.ok){const e=await d.json().catch((()=>({})));return l("Failed to track upload session:",e),{success:!1,error:"Failed to track upload session"}}return{success:!0,...await d.json()}}catch(e){return l("Error tracking upload session:",e instanceof Error?e.message:String(e)),{success:!1,error:e instanceof Error?e.message:"Failed to track upload session"}}}async uploadThumbnail(e,t){const s=new FormData;s.append("thumbnail",e);try{const e=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/videos/${t}/send-thumbnail`,{method:"POST",body:s,headers:{Authorization:`Bearer ${this.config.apiKey}`}}),i=await e.json();if(!i.success)throw new Error(i.message||"Thumbnail upload failed");return i}catch(e){throw new Error(e instanceof Error?e.message:"Failed to upload thumbnail")}}async getVideoStatus(e){try{const t=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/videos/${e}/status`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`}}),s=await t.json();if(!s.success)throw new Error(s.message||"Failed to get video status");return s}catch(e){throw new Error(e instanceof Error?e.message:"Failed to get video status")}}async listVideos(){try{const e=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/videos`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`}});l(`Videos list response status: ${e.status}`);const t=await e.json();return l("Videos list response data:",t),t.success?(l(`Successfully retrieved ${t.videos?t.videos.length:0} videos`),t):(l(`Videos list fetch failed: ${t.message||"Unknown error"}`),{success:!1,message:t.message||"Failed to retrieve videos"})}catch(e){return l(`Videos list error: ${e instanceof Error?e.message:"Unknown error"}`,e),{success:!1,message:e instanceof Error?e.message:"Failed to retrieve videos"}}}}e.VideonestEmbed=({videoId:e,config:t,style:s={}})=>{const{primaryColor:i,secondaryColor:o,darkMode:a,width:r,height:d,showTitle:l,showDescription:c}=s;let u=`https://app.videonest.co/embed/single/${e}`;const h=[];return i&&h.push(`primary_color=${i.replace("#","")}`),o&&h.push(`secondary_color=${o.replace("#","")}`),a&&h.push("dark_mode=true"),l&&h.push("show_title=true"),c&&h.push("show_description=true"),h.push(`channel_id=${t.channelId}`),h.push(`api_key=${t.apiKey}`),h.length>0&&(u+=`?${h.join("&")}`),n.createElement("iframe",{src:u,style:{width:r||"100%",height:d||"100%"},frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,title:`Videonest video ${e}`})},e.getVideoStatus=async function(e,t){return new p(t).getVideoStatus(e)},e.isDebugModeEnabled=function(){return r},e.listVideos=async function(e){return new p(e).listVideos()},e.setDebugMode=function(e){r=e,e?(a.default.enable("videonest-sdk"),"undefined"!=typeof window&&window.localStorage.setItem("debug","videonest-sdk"),console.log("[videonest-sdk] Debug mode enabled")):(a.default.disable(),"undefined"!=typeof window&&window.localStorage.removeItem("debug"))},e.uploadVideo=async function(e,t,s){return new p(s).uploadVideo(e,t)},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=videonest-sdk.umd.js.map
