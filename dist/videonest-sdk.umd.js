!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("debug"),require("react")):"function"==typeof define&&define.amd?define(["exports","debug","react"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VideonestSDK={},e.debugModule,e.React)}(this,(function(e,t,s){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function i(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var o=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,o.get?o:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var n=o(t),a=i(s);let r=!1;const d=n.default("videonest-sdk");const c=function(e,...t){r&&d(e,...t)};function l(e,...t){r&&(console.log(`[videonest-sdk] ${e}`,...t),d(e,...t))}function u(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}class h{constructor(){this.samples=[],this.avgSpeed=null}recordChunkUpload(e,t){const s=8*e/(t/1e3)/1e6;return this.samples.push(s),this.samples.length>3&&this.samples.shift(),this.avgSpeed=this.samples.reduce(((e,t)=>e+t))/this.samples.length,this.avgSpeed}shouldAdjustConcurrency(){return this.samples.length>=2}}class p{constructor(e,t,s){this.maxPossibleConcurrency=12,this.uploadQueue=[],this.activeUploads=new Map,this.completedChunks=new Set,this.failedChunks=new Set,this.speedDetector=new h,this.uploadId="",this.chunkBytesUploaded=new Map,this.totalBytesUploaded=0,this.workerPromises=[],this.file=e,this.metadata=t,this.config=s,this.maxConcurrency=6,this.chunkSize=function(e,t=null){let s;return s=e<52428800?5242880:e<524288e3?15728640:e<2147483648?36700160:78643200,t&&(t>50?s=Math.min(3*s,157286400):t>15?s=Math.min(2*s,104857600):t>8?s=Math.min(1.5*s,52428800):t<3&&(s=Math.max(.3*s,1048576))),Math.floor(s)}(e.size),this.totalChunks=Math.ceil(e.size/this.chunkSize)}async upload(e){const t=u();this.uploadId=t;for(let e=0;e<this.totalChunks;e++)this.chunkBytesUploaded.set(e,0);for(let e=0;e<this.totalChunks;e++)this.uploadQueue.push({index:e,uploadId:t,retries:0,maxRetries:2});for(let t=0;t<this.maxConcurrency;t++){const t=this.uploadWorker(e);this.workerPromises.push(t)}if(await Promise.all(this.workerPromises),this.failedChunks.size>0)throw new Error(`Failed to upload ${this.failedChunks.size} chunks`);return{uploadId:t,totalChunks:this.totalChunks}}async uploadWorker(e){for(;this.uploadQueue.length>0||this.activeUploads.size>0;){const t=this.uploadQueue.shift();if(t)try{await this.uploadChunk(t,e)}catch(e){console.error(`Chunk ${t.index} upload failed:`,e),t.retries<t.maxRetries?(t.retries++,this.uploadQueue.push(t)):this.failedChunks.add(t.index)}else await new Promise((e=>setTimeout(e,100)))}}async uploadChunk(e,t){const{index:s,uploadId:o}=e,i=s*this.chunkSize,n=Math.min(i+this.chunkSize,this.file.size),a=this.file.slice(i,n),r=a.size;if(0===r)throw new Error(`Empty chunk detected for index ${s}`);this.activeUploads.set(s,e);const d=new FormData;if(d.append("chunk",a),d.append("uploadId",o),d.append("chunkIndex",s.toString()),d.append("totalChunks",this.totalChunks.toString()),d.append("fileName",this.file.name),d.append("fileSize",this.file.size.toString()),0===s&&(d.append("channelId",this.metadata.channelId.toString()),this.metadata.title&&d.append("title",this.metadata.title),this.metadata.description&&d.append("description",this.metadata.description),this.metadata.tags)){const e=Array.isArray(this.metadata.tags)?this.metadata.tags.join(","):this.metadata.tags;e&&e.length>0&&d.append("tags",e)}const c=Date.now(),l=this.config.baseUrl||"https://api1.videonest.co";return new Promise(((e,o)=>{const i=new XMLHttpRequest;i.upload.onprogress=e=>{if(e.lengthComputable){const o=e.loaded;this.chunkBytesUploaded.set(s,o),this.totalBytesUploaded=Array.from(this.chunkBytesUploaded.values()).reduce(((e,t)=>e+t),0);const i=this.totalBytesUploaded/this.file.size*100;t(i)}},i.open("POST",`${l}/sdk/${this.config.channelId}/upload-chunk`),i.setRequestHeader("Authorization",`Bearer ${this.config.apiKey}`),i.onload=()=>{if(i.status>=200&&i.status<300)try{const t=JSON.parse(i.responseText);if(t.success){const o=Date.now()-c,i=this.speedDetector.recordChunkUpload(r,o);this.activeUploads.delete(s),this.completedChunks.add(s),this.chunkBytesUploaded.set(s,r),this.speedDetector.shouldAdjustConcurrency()&&s<.7*this.totalChunks&&this.adjustConcurrency(i),e(t)}else o(new Error(t.message||"Chunk upload failed"))}catch(e){o(new Error("Invalid response from server"))}else o(new Error("HTTP error: "+i.status))},i.onerror=()=>o(new Error("Network error during upload")),i.send(d)}))}adjustConcurrency(e){const t=this.maxConcurrency;if(e>50&&this.maxConcurrency<this.maxPossibleConcurrency?(this.maxConcurrency=Math.min(this.maxConcurrency+2,this.maxPossibleConcurrency),console.log(`üöÄ SDK: Boosting concurrency to ${this.maxConcurrency} (${e.toFixed(1)} Mbps)`)):e>25&&this.maxConcurrency<10?(this.maxConcurrency=Math.min(this.maxConcurrency+1,10),console.log(`‚ö° SDK: Increasing concurrency to ${this.maxConcurrency} (${e.toFixed(1)} Mbps)`)):e>15&&this.maxConcurrency<8?(this.maxConcurrency=Math.min(this.maxConcurrency+1,8),console.log(`‚ö° SDK: Moderate increase to ${this.maxConcurrency} (${e.toFixed(1)} Mbps)`)):e<5&&this.maxConcurrency>2?(this.maxConcurrency=Math.max(this.maxConcurrency-1,2),console.log(`üêå SDK: Reducing concurrency to ${this.maxConcurrency} (${e.toFixed(1)} Mbps)`)):e<1&&this.maxConcurrency>1&&(this.maxConcurrency=1,console.log(`üö® SDK: Emergency single thread (${e.toFixed(1)} Mbps)`)),this.maxConcurrency>t){const e=this.maxConcurrency-t;for(let t=0;t<e;t++){const e=this.uploadWorker((()=>{}));this.workerPromises.push(e)}}}}class f{constructor(e){this.config=e,c("VideonestClient initialized with channelId:",e.channelId)}async uploadVideo(e,t){var s;const o=u(),i=Date.now();l("Starting optimized video upload process"),l(`File: ${e.name}, size: ${e.size} bytes`),await this.trackVideoUpload("start",{sessionId:o,userId:"SDK",filename:e.name,fileSize:e.size,chunksCount:0,startTime:i,status:"in_progress"});try{const{metadata:n,onProgress:a=()=>{},thumbnail:r}=t;if(!r)throw l("Error: Thumbnail is required"),new Error("Thumbnail is required for video upload");l("Upload options:",{metadata:n,hasThumbnail:!!r});const d={...n,channelId:this.config.channelId};l("Upload metadata:",d);const c=new p(e,d,this.config),{uploadId:u,totalChunks:h}=await c.upload(a);l(`All chunks uploaded. Finalizing upload... (uploadId: ${u}, totalChunks: ${h})`);const f={fileName:e.name,uploadId:u,totalChunks:h.toString()};l("Finalize request data:",f);const m=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/finalize`,{method:"POST",body:JSON.stringify(f),headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`}});l(`Finalize response status: ${m.status}`);const g=await m.json();if(l("Finalize response data:",g),!g.success)throw l(`Finalization failed: ${g.message}`),new Error(g.message||"Upload finalization failed");return l("Upload successfully finalized"),l("Uploading user-provided thumbnail"),await this.uploadThumbnail(r,g.video.id),l("Upload process completed successfully"),await this.trackVideoUpload("complete",{sessionId:o,userId:"SDK",videoId:(null===(s=g.video)||void 0===s?void 0:s.id)||0,filename:e.name,fileSize:e.size,chunksCount:h,startTime:i,status:"completed"}),g}catch(t){return l(`Upload error: ${t instanceof Error?t.message:"Unknown error"}`,t),await this.trackVideoUpload("failed",{sessionId:o,userId:"SDK",videoId:0,filename:e.name,fileSize:e.size,chunksCount:0,startTime:i,status:"failed"}),{success:!1,message:t instanceof Error?t.message:"An unexpected error occurred during upload"}}}async trackVideoUpload(e,t){c("Tracking video upload:",e,t);try{let s,o="",i="POST";const n="https://api1.videonest.co";if("start"===e)o="/video-stats/upload-sessions",i="POST",s={session_id:t.sessionId,user_id:t.userId,video_id:t.videoId||0,filename:t.filename,file_size:t.fileSize,chunks_count:t.chunksCount||0,status:"in_progress"};else if(("complete"===e||"failed"===e)&&(o=`/video-stats/upload-sessions/${t.sessionId}`,i="POST",s={video_id:t.videoId,end_time:(new Date).toISOString(),status:t.status},t.startTime)){const e=Date.now()-t.startTime;if(s.total_duration=`${Math.floor(e/1e3)} seconds`,t.fileSize&&e>0){const o=8*t.fileSize/(e/1e3);s.avg_speed_mbps=parseFloat((o/1e6).toFixed(2))}}const a=`${n}${o}`;c("Upload session request:",{action:e,url:a,method:i,body:s});const r={"Content-Type":"application/json"};this.config.apiKey&&(r["X-API-Key"]=this.config.apiKey),this.config.channelId&&(r["X-Channel-ID"]=this.config.channelId.toString());const d=await fetch(a,{method:i,headers:r,body:JSON.stringify(s)});if(!d.ok){const e=await d.json().catch((()=>({})));return c("Failed to track upload session:",e),{success:!1,error:"Failed to track upload session"}}return{success:!0,...await d.json()}}catch(e){return c("Error tracking upload session:",e instanceof Error?e.message:String(e)),{success:!1,error:e instanceof Error?e.message:"Failed to track upload session"}}}async uploadThumbnail(e,t){const s=new FormData;s.append("thumbnail",e);try{const e=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/videos/${t}/send-thumbnail`,{method:"POST",body:s,headers:{Authorization:`Bearer ${this.config.apiKey}`}}),o=await e.json();if(!o.success)throw new Error(o.message||"Thumbnail upload failed");return o}catch(e){throw new Error(e instanceof Error?e.message:"Failed to upload thumbnail")}}async getVideoStatus(e){try{const t=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/videos/${e}/status`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`}}),s=await t.json();if(!s.success)throw new Error(s.message||"Failed to get video status");return s}catch(e){throw new Error(e instanceof Error?e.message:"Failed to get video status")}}async listVideos(){try{const e=await fetch(`https://api1.videonest.co/sdk/${this.config.channelId}/videos`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`}});c(`Videos list response status: ${e.status}`);const t=await e.json();return c("Videos list response data:",t),t.success?(c(`Successfully retrieved ${t.videos?t.videos.length:0} videos`),t):(c(`Videos list fetch failed: ${t.message||"Unknown error"}`),{success:!1,message:t.message||"Failed to retrieve videos"})}catch(e){return c(`Videos list error: ${e instanceof Error?e.message:"Unknown error"}`,e),{success:!1,message:e instanceof Error?e.message:"Failed to retrieve videos"}}}}e.VideonestEmbed=({videoId:e,config:t,style:s={}})=>{const{primaryColor:o,secondaryColor:i,darkMode:n,width:r,height:d,showTitle:c,showDescription:l}=s;let u=`https://app.videonest.co/embed/single/${e}`;const h=[];return o&&h.push(`primary_color=${o.replace("#","")}`),i&&h.push(`secondary_color=${i.replace("#","")}`),n&&h.push("dark_mode=true"),c&&h.push("show_title=true"),l&&h.push("show_description=true"),h.push(`channel_id=${t.channelId}`),h.push(`api_key=${t.apiKey}`),h.length>0&&(u+=`?${h.join("&")}`),a.createElement("iframe",{src:u,style:{width:r||"100%",height:d||"100%"},frameBorder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",allowFullScreen:!0,title:`Videonest video ${e}`})},e.getVideoStatus=async function(e,t){return new f(t).getVideoStatus(e)},e.isDebugModeEnabled=function(){return r},e.listVideos=async function(e){return new f(e).listVideos()},e.setDebugMode=function(e){r=e,e?(n.default.enable("videonest-sdk"),"undefined"!=typeof window&&window.localStorage.setItem("debug","videonest-sdk"),console.log("[videonest-sdk] Debug mode enabled")):(n.default.disable(),"undefined"!=typeof window&&window.localStorage.removeItem("debug"))},e.uploadVideo=async function(e,t,s){return new f(s).uploadVideo(e,t)},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=videonest-sdk.umd.js.map
